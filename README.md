# AWS Systems Manager Automation

Download the example execution role from the User Guide and save it as a YAML file.

```bash
(
   cd $(mktemp --dir)
   wget -q https://docs.aws.amazon.com/systems-manager/latest/userguide/samples/AWS-SystemsManager-AutomationExecutionRole.zip
   unzip -q AWS-SystemsManager-AutomationExecutionRole.zip
   cfn-flip AWS-SystemsManager-AutomationExecutionRole.json
) \
> execution_role.yaml
```

Add `iam:ListAccountAliases` to the list of allowed actions in the execution policy.

Create a stack set across the whole organization using the template.

Pass the management account ID as 480783779961.

Create an automation document to get the account alias.

```json
{
    "Name": "get_account_alias",
    "CreatedDate": "2022-08-14T00:39:36.406000+02:00",
    "DocumentVersion": "1",
    "Status": "Active",
    "Content": "{\n  \"description\" : \"Gets the account alias.\",\n  \"schemaVersion\" : \"0.3\",\n  \"mainSteps\" : [ {\n    \"name\" : \"get_account_alias\",\n    \"action\" : \"aws:executeAwsApi\",\n    \"outputs\" : [ {\n      \"Name\" : \"alias\",\n      \"Selector\" : \"$.AccountAliases[0]\",\n      \"Type\" : \"String\"\n    } ],\n    \"inputs\" : {\n      \"Service\" : \"iam\",\n      \"Api\" : \"ListAccountAliases\"\n    },\n    \"description\" : \"Get the account alias.\"\n  } ]\n}",
    "DocumentType": "Automation",
    "DocumentFormat": "JSON"
}
```

Print a comma separated list of all the accounts in the organization.

```
aws organizations list-accounts --profile sandbox-mgmt --query 'join(`,`, Accounts[].Id)' --output text
749430203777,345132479590,139442570134,975072629527,644347852375,480783779961,897617218731,973820050801
```

Remove the management account 480783779961 from the list. It doesn't have the execution role and so would fail.

Note the command generated by the console.

```bash
aws ssm start-automation-execution \
--document-name "get_account_alias" \
--document-version "\$DEFAULT" \
--target-locations '[
    {
        "Accounts":["749430203777","345132479590","139442570134","975072629527","644347852375","897617218731","973820050801"],
        "Regions":["eu-west-1"]
    }
]' \
--region eu-west-1
```

It executed successfully with execution ID 0fd2b51c-3837-47c1-8780-9ced6fb2ef2f.

Now show how to get the output though. It says "This execution has no outputs."

Maybe it needs an extra step to log to S3.

It also says that in a simple execution. But then the step shows in the output the alias.

The interface is janky.

In the CLI the single account execution returns the result.

```bash
aws ssm get-automation-execution \
--automation-execution-id b57cf0cc-a253-4af1-8df7-52bb38c6a7ca
```

```json
{
    "AutomationExecution": {
        "AutomationExecutionId": "b57cf0cc-a253-4af1-8df7-52bb38c6a7ca",
        "DocumentName": "get_account_alias",
        "DocumentVersion": "1",
        "ExecutionStartTime": "2022-08-14T01:31:55.599000+02:00",
        "ExecutionEndTime": "2022-08-14T01:31:56.462000+02:00",
        "AutomationExecutionStatus": "Success",
        "StepExecutions": [
            {
                "StepName": "get_account_alias",
                "Action": "aws:executeAwsApi",
                "ExecutionStartTime": "2022-08-14T01:31:55.882000+02:00",
                "ExecutionEndTime": "2022-08-14T01:31:56.427000+02:00",
                "StepStatus": "Success",
                "Inputs": {
                    "Api": "\"ListAccountAliases\"",
                    "Service": "\"iam\""
                },
                "Outputs": {
                    "alias": [
                        "isme-saa-general"
                    ]
                },
                "StepExecutionId": "d4de7d2b-29c3-4a88-ac9e-7606cb8b413c",
                "OverriddenParameters": {}
            }
        ],
        "StepExecutionsTruncated": false,
        "Parameters": {},
        "Outputs": {},
        "Mode": "Auto",
        "ExecutedBy": "arn:aws:sts::480783779961:assumed-role/AWSReservedSSO_AdministratorAccess_10cd3aecf3710de6/iain",
        "Targets": [],
        "ResolvedTargets": {
            "ParameterValues": [],
            "Truncated": false
        }
    }
}
```

The multi account execution returns an ExecutionId instead.

```bash
aws ssm get-automation-execution \
--automation-execution-id 0fd2b51c-3837-47c1-8780-9ced6fb2ef2f
```

```json
{
    "AutomationExecution": {
        "AutomationExecutionId": "0fd2b51c-3837-47c1-8780-9ced6fb2ef2f",
        "DocumentName": "get_account_alias",
        "DocumentVersion": "1",
        "ExecutionStartTime": "2022-08-14T01:24:34.084000+02:00",
        "ExecutionEndTime": "2022-08-14T01:26:07.392000+02:00",
        "AutomationExecutionStatus": "Success",
        "StepExecutions": [
            {
                "StepName": "749430203777_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:24:34.827000+02:00",
                "ExecutionEndTime": "2022-08-14T01:24:35.762000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "a126db9b-fd69-4c9e-8399-a7f8740fa816"
                    ]
                },
                "StepExecutionId": "222e8036-7ed6-45a7-a2fc-e51c28216f44",
                "OverriddenParameters": {}
            },
            {
                "StepName": "975072629527_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:24:45.205000+02:00",
                "ExecutionEndTime": "2022-08-14T01:24:46.166000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "cd140149-08f3-4ff2-a9aa-237a1d01d1d2"
                    ]
                },
                "StepExecutionId": "0af1d4f1-3bf2-46be-88da-bd95e2865bdc",
                "OverriddenParameters": {}
            },
            {
                "StepName": "644347852375_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:24:55.575000+02:00",
                "ExecutionEndTime": "2022-08-14T01:24:56.489000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "2020c7c0-fa9d-4b10-8170-35cdc1f3a105"
                    ]
                },
                "StepExecutionId": "ddb13891-a062-497c-a94a-f6cac5d2a4bc",
                "OverriddenParameters": {}
            },
            {
                "StepName": "345132479590_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:25:05.938000+02:00",
                "ExecutionEndTime": "2022-08-14T01:25:06.859000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "4b8433f3-ef70-4078-a76c-e4464cbdfaa0"
                    ]
                },
                "StepExecutionId": "bd00545a-bcd4-402f-9575-26926a3158d8",
                "OverriddenParameters": {}
            },
            {
                "StepName": "973820050801_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:25:16.275000+02:00",
                "ExecutionEndTime": "2022-08-14T01:25:17.210000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "d8ccfef5-0552-4570-9312-01bee8094f21"
                    ]
                },
                "StepExecutionId": "c840fff6-73bf-40ff-90e6-8d6ea1ce93bd",
                "OverriddenParameters": {}
            },
            {
                "StepName": "139442570134_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:25:26.707000+02:00",
                "ExecutionEndTime": "2022-08-14T01:25:27.650000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "28919ff8-884e-4792-8e15-25cb82971f89"
                    ]
                },
                "StepExecutionId": "0e2556dd-b371-4384-8977-d7aeea114ce1",
                "OverriddenParameters": {}
            },
            {
                "StepName": "897617218731_eu-west-1",
                "Action": "aws:executeAutomation",
                "ExecutionStartTime": "2022-08-14T01:25:37.066000+02:00",
                "ExecutionEndTime": "2022-08-14T01:25:38.026000+02:00",
                "StepStatus": "Success",
                "Inputs": {},
                "Outputs": {
                    "ExecutionId": [
                        "965f4a3a-d745-453a-9ac7-4d1e3973e89c"
                    ]
                },
                "StepExecutionId": "92f458be-d8b2-4018-9c83-60435f23c263",
                "OverriddenParameters": {}
            }
        ],
        "StepExecutionsTruncated": false,
        "Parameters": {},
        "Outputs": {},
        "Mode": "Auto",
        "ExecutedBy": "arn:aws:sts::480783779961:assumed-role/AWSReservedSSO_AdministratorAccess_10cd3aecf3710de6/iain",
        "Targets": [],
        "TargetMaps": [],
        "ResolvedTargets": {
            "ParameterValues": [],
            "Truncated": false
        },
        "TargetLocations": [
            {
                "Accounts": [
                    "749430203777",
                    "345132479590",
                    "139442570134",
                    "975072629527",
                    "644347852375",
                    "897617218731",
                    "973820050801"
                ],
                "Regions": [
                    "eu-west-1"
                ],
                "TargetLocationMaxConcurrency": "1",
                "TargetLocationMaxErrors": "0",
                "ExecutionRoleName": "AWS-SystemsManager-AutomationExecutionRole"
            }
        ],
        "ProgressCounters": {
            "TotalSteps": 7,
            "SuccessSteps": 7,
            "FailedSteps": 0,
            "CancelledSteps": 0,
            "TimedOutSteps": 0
        }
    }
}
```

I checked account 749430203777 and execution ID a126db9b-fd69-4c9e-8399-a7f8740fa816.

I can't find that ID in the target account or in the management account.

See the document about CloudWatch Logs. Maybe I can use scripts instead of API calls to write the output to a log.

# References

[AWS Systems Manager User Guide: Running automations in multiple AWS Regions and accounts](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-automation-multiple-accounts-and-regions.html)

[AWS Cloud Operations & Migrations Blog: Managing AWS resources across multiple accounts and Regions using AWS Systems Manager Automation](https://aws.amazon.com/blogs/mt/managing-aws-resources-across-multiple-accounts-and-regions-using-aws-systems-manager-automation/)

[Adrian Hornsby: Creating your own Chaos Monkey with AWS Systems Manager Automation](https://medium.com/the-cloud-architect/creating-your-own-chaos-monkey-with-aws-systems-manager-automation-6ad2b06acf20)

[AWS Systems Manager User Guide: Logging Automation action output with CloudWatch Logs](https://docs.aws.amazon.com/systems-manager/latest/userguide/automation-action-logging.html)